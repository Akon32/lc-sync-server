#!/bin/sh

test -z "${WORK_DIR}" && WORK_DIR=/
cd ${WORK_DIR}

ERL_PATH=usr/share/syncserver/ebin

CONFIG_FILE=etc/syncserver/syncserver.config

COOKIE_FILE=etc/syncserver/cookie

SNAME="syncserver@$(uname -n)"

APPLIST='[sasl,mnesia,syncserver]'

START_SCRIPT="
	Node='$SNAME',
	io:format(\"Starting Syncserver on node ~p..~n\",[Node]),
	lists:foreach(fun(A)->
			io:format(\"Starting application ~p.. \",[A]),
			SR=application:start(A),
			io:format(\"~p~n\",[SR]),
			ok=SR
			end, $APPLIST),
	io:format(\"Syncserver started~n\",[])."

STOP_SCRIPT="
	Node='$SNAME',
	io:format(\"Stopping Syncserver on node ~p..~n\",[Node]),
	lists:foreach(fun(A)->
			io:format(\"Stopping application ~p.. \",[A]),
			SR=rpc:call(Node,application,stop,[A]),
			io:format(\"~p~n\",[SR])
			end, lists:reverse($APPLIST)),
	io:format(\"Shutdown node ~p.. \",[Node]),
	R=rpc:call(Node,init,stop,[]),
	io:format(\"~p~n\",[R]),
	io:format(\"Shutdown this node~n\",[]),
	init:stop()."

CREATE_DB_SCRIPT="
	try
		io:format(\"Creating database...\",[]),
		R=util:create_db(),
		io:format(\" ~p~n\",[R])
	after
		init:stop()
	end."

COOKIE=$(cat ${COOKIE_FILE} 2>/dev/null)

COOKIE_OPT="-setcookie '$COOKIE'"
test -z $COOKIE && COOKIE_OPT=

ERL_OPTIONS="-detached -pa $ERL_PATH -sname $SNAME 
	-config ${CONFIG_FILE} $COOKIE_OPT"
ERL_OPTIONS_SHELL="-pa $ERL_PATH -sname $SNAME 
	-config ${CONFIG_FILE} $COOKIE_OPT"
ERL_OPTIONS_STOP="-noshell -sname stop-syncserver 
	-config ${CONFIG_FILE} $COOKIE_OPT"
ERL_OPTIONS_CREATEDB="-noshell -pa $ERL_PATH -sname db-syncserver 
	-config ${CONFIG_FILE} $COOKIE_OPT"

case $1 in
	start) 
	    exec erl ${ERL_OPTIONS} -eval "$START_SCRIPT"
	;;
	start-shell) 
	    exec erl ${ERL_OPTIONS_SHELL} -eval "$START_SCRIPT"
	;;
	stop)
	    exec erl ${ERL_OPTIONS_STOP} -eval "$STOP_SCRIPT"
	;;
	create-db)
	    exec erl ${ERL_OPTIONS_CREATEDB} -eval "$CREATE_DB_SCRIPT"
	;;
	create-cookie)
		{ cat /dev/urandom|head -c32|md5sum|head -c32 > ${COOKIE_FILE}
		} &&	chmod 400 ${COOKIE_FILE} &&	echo "Cookie file created."
	;;
	*)
		echo "Synchronization Server"
	    echo "Usage:"
	    echo " $0 start"
	    echo " $0 start-shell"
	    echo " $0 stop"
	    echo " $0 create-db"
	    echo " $0 create-cookie"
	;;
esac

